<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>发布职位</title>
    <script src="../layui/layui.js"></script>
    <script src="../js/jquery-3.5.1.min.js"></script>
    <script src="../js/jump.js"></script>
    <script src="../js/city.js"></script>
    <link rel="stylesheet" href="../layui/css/layui.css">
</head>
<body>
<form class="layui-form" action="" style="margin: 20px 40px 20px 40px">
    <div class="layui-form-item" style="display: inline-block">
        <label class="layui-form-label">职位名称</label>
        <div class="layui-input-block">
            <input type="text" name="pname" required id="pname" lay-verify="required" lay-reqText="职位名称不能为空" placeholder="职位名称" autocomplete="off" class="layui-input" disabled="disabled">
        </div>
    </div>
    <div class="layui-form-item" style="display: inline-block">
        <label class="layui-form-label">工作城市</label>
        <div class="layui-input-block" style="display: inline-block; margin-left: 0px;">
            <select name="plocation" lay-verify="required" lay-reqText="请选择省份" id="province" lay-filter="province" disabled="disabled">
                <option value="">请选择省份</option>
            </select>
        </div>
        <div class="layui-input-block" style="display: inline-block; margin-left: 10px;">
            <select name="plocation" lay-verify="required" lay-reqText="请选择城市" id="city" disabled="disabled">
                <option value="">请选择城市</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item" style="display: inline-block">
        <label class="layui-form-label">详细地址</label>
        <div class="layui-input-block">
            <input type="text" name="plocation" id="plocation" placeholder="详细地址" autocomplete="off" class="layui-input" disabled="disabled">
        </div>
    </div>
    <div class="layui-form-item" style="display: inline-block">
        <label class="layui-form-label">职位状态</label>
        <div class="layui-input-block">
            <input type="radio" name="pisopen" value="1" title="开放" checked disabled>
            <input type="radio" name="pisopen" value="0" title="关闭" disabled>
        </div>
    </div>
    <div class="layui-form-item" style="display: inline-block">
        <label class="layui-form-label" style="text-align: center">工作经验学历要求</label>
        <div class="layui-input-block" style="display: inline-block; margin-left: 0px;">
            <select name="pexperience" lay-verify="required" disabled="disabled" id="pexperience">
                <option value="经验不限">经验不限</option>
                <option value="在校生">在校生</option>
                <option value="应届生">应届生</option>
                <option value="1年以内">1年以内</option>
                <option value="1-3年">1-3年</option>
            </select>
        </div>
        <div class="layui-input-block" style="display: inline-block; margin-left: 15px;">
            <select name="pacademic" lay-verify="required" disabled="disabled" id="pacademic">
                <option value="学历不限">学历不限</option>
                <option value="大专">大专</option>
                <option value="本科">本科</option>
                <option value="研究生">研究生</option>
                <option value="博士生">博士生</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item" style="display: inline-block">
        <div class="layui-inline">
            <label class="layui-form-label">薪资范围</label>
            <div class="layui-input-inline" style="width: 100px;">
                <input type="text" name="psalary" placeholder="￥" autocomplete="off" id="price_min" class="layui-input" required lay-verify="required" lay-reqText="请输入薪资要求" disabled="disabled">
            </div>
            <div class="layui-form-mid">-</div>
            <div class="layui-input-inline" style="width: 100px;">
                <input type="text" name="psalary" placeholder="￥" autocomplete="off" id="price_max" class="layui-input" required lay-verify="required" lay-reqText="请输入薪资要求" disabled="disabled">
            </div>
        </div>
    </div>
    <div class="layui-form-item layui-form-text" style="display: inline-block; width: 40%">
        <label class="layui-form-label">职位描述</label>
        <div class="layui-input-block">
            <textarea name="pcontent" placeholder="请输入内容" id="pcontent" class="layui-textarea" required lay-verify="required" lay-reqText="请输入职位描述" disabled="disabled"></textarea>
        </div>
    </div>
    <div class="layui-form-item layui-form-text" style="display: inline-block; width: 40%">
        <label class="layui-form-label">任职要求</label>
        <div class="layui-input-block">
            <textarea name="pneed" placeholder="请输入内容" id="pneed" class="layui-textarea" required lay-verify="required" lay-reqText="请输入任职要求" disabled="disabled"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button type="button" class="layui-btn" onclick="Edit(this)" id="edit">编辑</button>
            <button class="layui-btn" lay-submit lay-filter="doSubmit" style="display: none" id="commit">发布</button>
            <button type="reset" class="layui-btn layui-btn-primary" style="display: none" id="reset">重置</button>
            <button type="button" class="layui-btn" style="display: none" id="cancel" onclick="Cancel(this)">取消</button>
        </div>
    </div>
</form>

<div style="width: 80%; margin-left: 100px; margin-top: 40px">
    <form class="layui-form" action="">
        <div class="layui-form-item" style="display: inline-block;">
            <label class="layui-form-label">简历状态</label>
            <div class="layui-input-block">
                <select name="astatus" lay-filter="deal" id="deal">
                    <option value="未处理" selected="selected">未处理</option>
                    <option value="等待面试">等待面试</option>
                    <option value="已拒绝">已拒绝</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item" style="display: inline-block;">
            <div class="layui-input-block" style="margin-left: 24px;">
                <input type="text" name="aname" required  lay-verify="required" lay-reqText="请输入要查询的应聘者的名字" placeholder="输入应聘者名字查询" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" style="display: inline-block;">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="doSearch">搜索</button>
            </div>
        </div>
    </form>
</div>
<div style="margin-left: 40px; margin-right: 40px; margin-bottom: 40px">
    <table id="ResumeList" lay-filter="ResumeTable"></table>
    <!-- 头部工具栏 -->
    <script type="text/html" id="ResumeToolbar">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm" lay-event="batchInterview">通知面试</button>
            <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="batchDelete">拒绝</button>
        </div>
    </script>
    <!-- 行工具栏 -->
    <script type="text/html" id="ResumeRowBar">
        <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="interview">通知面试</button>
        <button class="layui-btn layui-btn-xs" lay-event="delete">拒绝</button>
    </script>
</div>

<script>
    let pid;
    window.onload = function (){
        pid = window.location.search.split("=")[1];
        console.log(pid);

        layui.use(['form', 'layer', 'table'], function() {
            var form = layui.form;
            var $ = layui.jquery;
            var layer = layui.layer;
            var table = layui.table;

            $.ajax({
                url: "/company/positionData",
                type: "post",
                data: {
                    "pid": pid
                },
                success: function (res){
                    console.log(res);
                    document.querySelector("#pname").value = res.pname;
                    document.querySelector("#pcontent").innerText = res.pcontent;
                    document.querySelector("#pneed").innerText = res.pneed;
                    let province = res.plocation.split(",")[0];
                    let city = res.plocation.split(",")[1];
                    let address = res.plocation.split(",")[2];
                    if(address == null) address = "";
                    let selects = document.querySelector("#province");
                    selects.disabled = false;
                    for (var i=0; i<selects.options.length; i++) {
                        if(selects.options[i].value == province){
                            selects.options[i].selected = true;
                            break;
                        }
                    }

                    let select = document.querySelector("#city");
                    select.disabled = false;
                    const opt = document.createElement("option");
                    opt.value = city;
                    opt.innerText = city;
                    opt.selected = true;
                    select.appendChild(opt);
                    select.disabled = true;
                    selects.disabled = true;

                    selects = document.querySelector("#pacademic");
                    for (var i=0; i<selects.options.length; i++) {
                        if(selects.options[i].value == res.pacademic){
                            selects.options[i].selected = true;
                            break;
                        }
                    }

                    selects = document.querySelector("#pexperience");
                    for (var i=0; i<selects.options.length; i++) {
                        if(selects.options[i].value == res.pexperience){
                            selects.options[i].selected = true;
                            break;
                        }
                    }

                    let radios = document.querySelectorAll("input[type='radio']");
                    for (const radio of radios) {
                        if(radio.value == res.pisopen){
                            radio.checked = true;
                        }
                    }

                    document.querySelector("#price_min").value = res.psalary.split(",")[0];
                    document.querySelector("#price_max").value = res.psalary.split(",")[1];

                    layui.use(['form'], function (){
                        var form = layui.form;

                        form.render("select");
                        form.render("radio");
                    })
                },
                error: function (res){
                    console.log(res);
                }
            })
        });

    };

    (function setDefault(){
        var prov = document.querySelector("#province");
        let len = provice.length;
        for(let i=0; i<len; i++){
            var provOpt = document.createElement("option");
            provOpt.innerText = provice[i]["name"];
            provOpt.setAttribute("index", i);
            provOpt.value = provice[i]["name"];
            prov.appendChild(provOpt);
        }
    })();

    function Edit(o){
        o.style.display = "none";
        document.querySelector("#commit").style.display = "";
        document.querySelector("#reset").style.display = "";
        document.querySelector("#cancel").style.display = "";

        let inputs = document.querySelectorAll("input");
        for (const input of inputs) {
            input.disabled = false;
        }

        let selects = document.querySelectorAll("select");
        for (const select of selects) {
            select.disabled = false;
        }

        let textareas = document.querySelectorAll("textarea");
        for (const textarea of textareas) {
            textarea.disabled = false;
        }

        layui.use(['form'], function (){
            var form = layui.form;
            form.render("select");
            form.render("radio");
        })
    }

    function Cancel(o){
        o.style.display = "none";
        document.querySelector("#commit").style.display = "none";
        document.querySelector("#reset").style.display = "none";
        document.querySelector("#edit").style.display = "inline-block";

        let inputs = document.querySelectorAll("input");
        for (const input of inputs) {
            input.disabled = true;
        }

        let selects = document.querySelectorAll("select");
        for (const select of selects) {
            select.disabled = true;
        }

        let textareas = document.querySelectorAll("textarea");
        for (const textarea of textareas) {
            textarea.disabled = true;
        }

        layui.use(['form'], function (){
            var form = layui.form;
            form.render("select");
            form.render("radio");
        })
    }


    //Demo
    layui.use(['form', 'layer', 'table'], function(){
        var form = layui.form;
        var $ = layui.jquery;
        var layer = layui.layer;
        var table = layui.table;

        form.on("select(province)", function (data){

            var city = document.querySelector("#city");
            let province = document.querySelector("#province");
            let i = province.selectedIndex;
            let val = province.options[i].getAttribute("index");
            city.length = 1;
            if(val != "" && val != null){
                var cityLen = provice[val]["city"].length;
                for(let i=0; i<cityLen; i++){
                    var cityOpt = document.createElement("option");
                    cityOpt.innerText = provice[val]["city"][i].name;
                    cityOpt.setAttribute("index", i);
                    cityOpt.value = provice[val]['city'][i].name;
                    city.appendChild(cityOpt);
                }
            }
            form.render('select');
        })

        //监听提交
        form.on('submit(doSubmit)', function(data){
            console.log(data);
            data.field = decodeURIComponent($(data.form).serialize());
            layer.msg(JSON.stringify(data.field));
            data.field += `&pid=${pid}`;
            console.log(data);

            $.post("/company/updatePosition", data.field, function (res){
                console.log(res);
                if(res.success){
                    window.location.href = `./JobInfo.html?pid=${pid}`;
                }else {
                    layer.msg("发布失败，请重试");
                }
            })
            //禁止页面的跳转
            return false;
        });

        function setA(data){
            console.log(data);
            return `<a href="javascript:void(0);" onclick="fileDownload(${data.aid}, ${pid})">下载简历</a>`;
        }

        let selects = document.querySelector("#deal");


        var tableIns = table.render({
            elem: '#ResumeList'
            ,height: 312
            ,url: `/company/showResume?pid=${pid}&astatus="未处理"` //数据接口
            ,method: "post"
            ,toolbar: "#ResumeToolbar"
            ,page: true //开启分页
            ,cols: [[ //表头
                {type: "checkbox", fixed: "left", width: 80, align: "center"},
                {field: "aid", title: "id", hide: true, align: "center"},
                {field: 'aname', title: '应聘者', align: "center"},
                {field: 'asex', title: '性别', align: "center"},
                {field: 'aage', title: '年龄', align: "center"},
                {field: 'aeducation', title: '学历', align: "center"},
                {field: 'ajobstatus', title: '求职状态', align: "center"},
                {field: 'aemail', title: '邮箱', align: "center"},
                {field: 'aphone', title: '电话', align: "center"},
                {field: 'afilepath', title: "简历", align: "center", templet: setA},
                {field: 'astatus', title: "简历状态"},
                {field: "opt", title: "操作", toolbar: "#ResumeRowBar", align: "center", fixed: "right", width: 200}
            ]],
            done: function (){
                // const type = document.querySelector("");
            }
        });

        form.on("select(deal)", function (data){
            console.log(data);
            tableIns.reload({
                url: "/company/showResume",
                method: "post",
                where: {
                    "pid": pid,
                    "astatus": data.value
                },
                page: {
                    curr: 1
                }
            })
        })

        //点击搜索
        form.on("submit(doSearch)", function (data){
            console.log(data.field);
            let newData;
            newData.aname = data.field.aname;
            newData.apid = pid;
            tableIns.reload({
                url: "",
                where: newData,  //查询条件
                page: {
                    curr: 1
                }
            })
            return false;
        })

        table.on("toolbar(ResumeTable)", function (obj){
            console.log(obj);
            batchInter(obj.data, obj.event);
        })

        // //监听表格行工具栏事件
        table.on("tool(ResumeTable)",function (obj) {
            console.log(obj);
            inter(obj.data, obj.event);
        });

        function inter(data, event){
            let news = "";
            let url = "";
            if(event == "delete") {news = "拒绝"; url = "/company/refuseResume";}
            else {news = "通知面试"; url = "/company/acceptResume";}
            layer.confirm(`确定要${news}${data.aname}吗？`, {icon:3,title:"提示"}, function (index){
                $.post(url, {"aaid": data.aid, "apid": pid}, function (res){
                    if(res.success){
                        layer.alert(res.message,{icon:1});
                        //关闭窗口
                        //刷新数据表格
                        tableIns.reload();
                    }else {
                        layer.alert(res.message,{icon:2});
                    }
                }, "json");
                layer.close(index);
            })
        }

        function batchInter(data, event) {
            let news = "";
            let url = "";
            if (event == "batchInterview") {news = "通知"; url="/company/batchAcceptResume";}
            else {news = "拒绝"; url="/company/batchRefuseResume";}

            var checkStatus = table.checkStatus("ResumeList");
            if (checkStatus.data.length > 0) {
                var List = [];
                for (let i = 0; i < checkStatus.data.length; i++) {
                    List.push({"aaid": checkStatus.data[i].aid, "apid": pid});
                }
                console.log(List);
                List = JSON.stringify(List);
                layer.confirm(`确定要${news}这${checkStatus.data.length}位应聘者面试吗？`, {
                    icon: 3,
                    title: "提示"
                }, function (index) {
                    $.post(url, {"list": List}, function (res) {
                        if (res.success) {
                            layer.alert(res.message, {icon: 1});
                            //刷新数据表格
                            tableIns.reload();
                        } else {
                            layer.alert(res.message, {icon: 2});
                        }
                    }, "json");
                    layer.close(index);
                })
            } else {
                layer.msg("请选择要处理的应聘者！");
            }
        }
    });
</script>
</body>
</html>